# Training Score Sessions Formula
# Orchestrates session scoring workflow for training data enrichment
# Part of Epic B: Formula Authoring (lf-ymji)

version = "1.0"
type = "workflow"

[variables]
scope = { type = "string", default = "unscored", description = "Scope of sessions to score: 'all', 'recent', or 'unscored-only'" }
output_dir = { type = "string", default = "output/scored_sessions", description = "Directory for scored session outputs" }
report_format = { type = "string", default = "json", description = "Format for scoring report: 'json' or 'csv'" }

[steps.discover_sessions]
description = "Discover sessions to score based on scope parameter"
command = "python scripts/discover_sessions.py --scope {{scope}} --output {{output_dir}}/sessions_to_score.json"
needs = []
outputs = ["{{output_dir}}/sessions_to_score.json"]
notes = """
Discovers sessions based on the specified scope:
- 'all': scores all available sessions
- 'recent': scores sessions from the last 7 days  
- 'unscored-only': scores only sessions without existing quality scores

Outputs a JSON file listing session paths to be scored.
"""

[steps.score_sessions]
description = "Run session_scorer.py on each discovered session"
command = "python data/transform/session_scorer.py --input {{output_dir}}/sessions_to_score.json --output {{output_dir}}/scored_sessions.json"
needs = ["discover_sessions"]
outputs = ["{{output_dir}}/scored_sessions.json"]
notes = """
Processes each session through the session_scorer.py module which:
- Computes turn-level scores based on tool success rate and error recovery
- Computes step-level scores based on artifact production and escalation count  
- Computes formula-level scores based on completion rate and duration efficiency
- Composes final quality score using configurable weights

Outputs enriched sessions with quality_score metadata field.
"""

[steps.generate_report]
description = "Generate scoring report with distribution, coverage, and outliers"
command = "python scripts/generate_scoring_report.py --input {{output_dir}}/scored_sessions.json --format {{report_format}} --output {{output_dir}}/scoring_report.{{report_format}}"
needs = ["score_sessions"]
outputs = ["{{output_dir}}/scoring_report.{{report_format}}"]
notes = """
Generates comprehensive scoring report including:
- Score distribution statistics (mean, median, std dev)
- Coverage metrics (percentage of sessions scored)
- Outlier detection (sessions with scores >2 std dev from mean)
- Quality thresholds analysis

Report format can be JSON (structured) or CSV (tabular).
"""

[steps.output_dataset]
description = "Output enriched training dataset with outcome scores in metadata"
command = "python scripts/enrich_training_dataset.py --input {{output_dir}}/scored_sessions.json --output {{output_dir}}/enriched_training_dataset.json"
needs = ["generate_report"]
outputs = ["{{output_dir}}/enriched_training_dataset.json"]
notes = """
Creates final enriched training dataset where each session includes:
- Original session data
- quality_score field (0.0-1.0)
- scoring_metadata with level-specific scores
- outlier flag for sessions outside normal distribution

This dataset is ready for use in training pipelines.
"""